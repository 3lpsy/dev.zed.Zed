# dev.zed.Zed.yaml
app-id: dev.zed.Zed
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: zed
separate-locales: false
finish-args:
  # Grant access to Direct Rendering Infrastructure (DRI) for GPU acceleration
  - --device=dri

  # Allow access to the user's home directory for reading and writing files
  - --filesystem=home

  # Allow shared memory access for inter-process communication
  - --share=ipc

  # Enable network access
  - --share=network

  # Provide access to X11 display server as a fallback
  - --socket=fallback-x11

  # Enable access to PulseAudio sound server
  - --socket=pulseaudio

  # Enable access to Wayland display server
  - --socket=wayland

modules:
  - name: zed
    buildsystem: simple
    build-commands:
      # Install Zed
      - install -Dm 755 bin/* --target-directory ${FLATPAK_DEST}/bin
      - install -Dm 755 lib/* --target-directory ${FLATPAK_DEST}/lib
      - install -Dm 755 libexec/* --target-directory ${FLATPAK_DEST}/libexec

      # Install {Desktop,MetaInfo}
      - install -Dm 644 share/applications/* --target-directory ${FLATPAK_DEST}/share/applications
      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml --target-directory ${FLATPAK_DEST}/share/metainfo

      # Install Icons (Max. size 512x512)
      - install -Dm 644 share/icons/hicolor/512x512/apps/zed.png --target-directory ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps

      # Rename zed to ${FLATPAK_ID}
      - rename zed ${FLATPAK_ID} ${FLATPAK_DEST}/share/{applications/*,icons/hicolor/*/apps/*}

      # Modify `.desktop` file to use the correct icon name
      - sed -i "s/^Icon=zed$/Icon=${FLATPAK_ID}/" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      # Cleanup
      - rm -rf {bin,lib,libexec,share}
    sources:
      # Zed Editor Releases
      # x86_64
      - type: archive
        url: https://github.com/zed-industries/zed/releases/download/v0.144.4/zed-linux-x86_64.tar.gz
        sha256: 77193187c4e87c743cfcb9a058bfa08b93f6c85d93c8143bab2599dfe8b8346d
        only-arches:
          - x86_64
        x-checker-data:
          type: github
          owner: zed-industries
          repo: zed
          tag-pattern: ^v(\d+\.\d+\.\d+)$
          url-template: "https://github.com/zed-industries/zed/releases/download/v$version/zed-linux-x86_64.tar.gz"
          hash-algo: sha256

      # arm64
      - type: archive
        url: https://github.com/zed-industries/zed/releases/download/v0.144.4/zed-linux-aarch64.tar.gz
        sha256: c3f213952914657a208a2fc4060b4ba7cf3313f4fd6c9b0561377e75bf32747a
        only-arches:
          - aarch64
        x-checker-data:
          type: github
          owner: zed-industries
          repo: zed
          tag-pattern: ^v(\d+\.\d+\.\d+)$
          url-template: "https://github.com/zed-industries/zed/releases/download/v$version/zed-linux-aarch64.tar.gz"
          hash-algo: sha256

        # MetaInfo
      - type: file
        path: dev.zed.Zed.metainfo.xml
